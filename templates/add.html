<!DOCTYPE html>
<html>
{% from 'macros.html' import head, nav, importJs, bodyPaddingNav %}

{{ head('Add Schedule - PreMatch') }}
<script type="text/javascript" src="/static/js/addSchedule.js"></script>
<body id="body" class="bg-primary">

{{ nav(True, '/edit', handle) }}

{{ bodyPaddingNav() }}

<section class="section pushed" style="z-index: 9999999;">
    <form method="POST" action="/update" id="form-invis">
        {% for period in 'ABCDEFG' %}
        <input type="hidden" name="{{ period }}" id="input-invis-{{ period }}">
        {% endfor %}
    </form>

    <div class="box has-text-centered" style="width: 50%; margin: 0 auto; padding: 20px; z-index: 99999999;">
        {% if schedule == none %}
            {% if name != '' %}
                <h1 class="title is-size-1">Welcome, {{ name }}!</h1>
            {% endif %}
        {% else %}
            {% if name != '' %}
                <h1 class="title is-size-1">Welcome back, {{ name }}!</h1>
            {% endif %}
        {% endif %}

        {% if schedule == none %}
            {% if name != '' %}
                <h2 class="subtitle is-size-4" style="color: black!important;">Please input your schedule below</h2>
            {% endif %}
        {% else %}
            {% if name != '' %}
                <h2 class="subtitle is-size-4" style="color: black!important;">Your current schedule is posted below. You may edit it if you wish by selecting a different teacher and pressing "update."</h2>
            {% endif %}
        {% endif %}

        <form id="form" style="height: auto; margin-bottom: 40px;">
            {% for period in 'ABCDEFG' %}
            <div class="teacher-dropdown" id="dropdown-container-{{ period }}">
                <div class="teacher-dropdown-content" id="teacher-dropdown-{{ period }}">
                    <label class="block-label" for="teacherInput{{ period }}">Block {{ period }}:</label>
                    <br>
                    <input type="text" placeholder="Search for a teacher..." id="teacherInput{{ period }}"
                           onkeyup="filterTeachers('{{ period }}')" onfocus="selectInput('{{ period }}')">
                    <div class="link-holder has-text-left" id="link-holder-{{ period }}">
                        {% for teacher in teachers %}
                        <a style="display: none;" id="{{ teacher }}-{{ period }}"
                           onclick="selectTeacher(&quot;{{ period }}&quot;, &quot;{{ teacher|safe }}&quot;)">{{ teacher }}</a>
                        {% endfor %}
                        <p style="display: none;" id="no-results-{{ period }}">No teachers found</p>
                    </div>
                </div>
                <div class="notification is-primary" id="teacher-notif-{{ period }}">
                    <button type="button" class="delete" onclick="unselectTeacher('{{ period }}')"></button>
                    <p class="block-label">Block {{ period }}:</p>
                    <p id="teacher-notif-text-{{ period }}"></p>
                    {% if schedule != none %}
                        <a class="button is-outlined is-primary is-medium" data-href-base="/roster/{{ period }}/" id="view-roster-{{ period }}" style="border-radius: 10px;">View Classmates</a>
                    {% endif %}
                </div>

            </div>
            {% endfor %}
            {% if schedule != none %}
                <script type="text/javascript">
                {% for period in 'ABCDEFG' %}
                    {% if schedule[period] != '' %}
                            selectTeacher('{{ period }}', '{{ schedule[period] }}');
                    {% endif %}
                {% endfor %}
                </script>
            {% endif%}
        </form>
        <script type="text/javascript">
            let teachers = {{teachers | tojson}};

            function submitChanges(periods) {

                let valid = true;
                periods.forEach((period) => {
                    let form = document.getElementById('form-invis');

                    let input = form.querySelector(`#input-invis-${period}`);
                    let value = input.value;
                    console.log(value, period);
                    if (!(value.length > 0)) {
                        valid = false;
                    } else {
                        if (!teachers.includes(value)) {
                            valid = false;
                        }
                    }
                });

                if (valid) {
                    document.getElementById('form-invis').submit();
                } else {
                    document.getElementById('err-msg').innerHTML = "Sorry, but your form isn't valid! <br> Make sure <strong>all of your classes have a teacher selected</strong> and that you <strong>didn't</strong> try to edit the site's code to break it."
                }
            }
        </script>
        {% if schedule != none %}
        <a class="button is-outlined is-primary is-large"
           onclick="submitChanges('ABCDEFG'.split(''))">Update</a>
        {% else %}
        <a class="button is-outlined is-primary is-large"
           onclick="submitChanges('ABCDEFG'.split(''))">Submit</a>
        {% endif %}

        <h1 id="err-msg" style="margin-top: 20px; font-size: 20px;"></h1>

        <script type="text/javascript">
            setOriginalMargin();
        </script>
    </div>
</section>

{{ importJs() }}

</body>
</html>