export const calendar = {
    versionMajor: 1,
    versionMinor: 0,
	teachers: [
         'Abbott',
         'Allen',
         'Aman',
         'Armstrong',
         'Arnold',
         'Aubrey',
         'Avcioglu',
         'Bach',
         'Bailey',
         'Bergey',
         'Bergner',
         'Bernie',
         'Berube',
         'Blank',
         'Bledsoe',
         'Bock',
         'Bolden',
         'Bonin',
         'Bouchard',
         'Bourgeios',
         'Bradney',
         'Breen',
         'Brennan',
         'Brown',
         'Burch',
         'Burke',
         'Burm',
         'Burns',
         'Butkowich',
         'Camilo',
         'Campbell',
         'Caron, Alison',
         'Caron, Evelyn',
         'Cataldo',
         'Caveney',
         'Cesar',
         'Chachus',
         'Chaff',
         'Chaves-Whitehead',
         'Cherry',
         'Choquette',
         'Ciampa',
         'Collins, Jennifer',
         'Collins, Lisa',
         'Conrad',
         'Consentino',
         'Costagliola',
         'Costello, Jim',
         'Costello, Kerry',
         'Coufus',
         'Couture',
         'Cross',
         'Croswell',
         'Crowley',
         'Cummings',
         'Cutler',
         "D'Alise",
         'Damphousse',
         'Danos',
         'Darlington',
         'Davidson',
         'Davis',
         'Daviso',
         'Day',
         'DeGenova',
         'Delforge',
         'Deschenes',
         'Desfosse',
         'Deshler',
         'Desjardins',
         'DiBenedetto',
         'Dierze',
         'Donovan',
         'Doucet',
         'Drueke',
         'Dubois',
         'Duford',
         'Duncan',
         'Dwyer',
         'Emery',
         'Emory',
         'Farra',
         'Fazio',
         'Fields',
         'Fisher',
         'Fitzgerald',
         'Foley',
         'Fortier',
         'Francis',
         'Frisk',
         'Ganci',
         'Ganley',
         'Garcia',
         'Gardner',
         'Gaudiano',
         'Gelinas',
         'Germaine',
         'Gibson, Brendan',
         'Gibson, Joanne',
         'Giggie',
         'Gillespie',
         'Givens',
         'Gleason',
         'Gonzalez',
         'Gould',
         'Grange',
         'Griffin',
         'Gupte',
         'Hall, Matthew',
         'Hall, Peter',
         'Hamilton',
         'Hand',
         'Hawes',
         'Hecht',
         'Hibino, Alan',
         'Hibino, Krista',
         'Hinchcliff',
         'Hoar',
         'Hofius',
         'Holm-Andersen',
         'Hopkins',
         'Houston',
         'Howansky',
         'Howell',
         'Howland',
         'Hutchins',
         'Iannuccilli',
         'Jamgochian',
         'Janeiro',
         'Jannetti',
         'Johnson',
         'Jones',
         'Jordan',
         'Kalf',
         'Kapamajian',
         'Keeler',
         'Keene',
         'Kinsman',
         'Kirby',
         'Kostousova',
         'Koutroubas',
         'Kropiwnicki',
         'Kuhlmann',
         "L'Ecuyer",
         'Langevin',
         'Lawrence',
         'Lemieux',
         'Lenzi',
         'Levin',
         'Maglione',
         'Mandelbaum',
         'Maniachi',
         'Martin, Bill',
         'Martin, John',
         'Martin, Melissa',
         'Marx',
         'Masters',
         'Mathews',
         'Mazman-Stevens',
         'McCarthy',
         'McDonie',
         'McManus',
         'McNally',
         'McVeigh',
         'Meagher',
         'Meehan',
         'Meltsakos',
         'Messina',
         'Michaud, Meghan',
         'Michaud, Rob',
         'Mitchell',
         'Mugford',
         'Mulert',
         'Murnane',
         'Najarian',
         'Namvar',
         'Nice',
         'Niles',
         'Norton',
         "O'Donnell",
         'Palen',
         'Paminger',
         'Papadopoulos',
         'Paris',
         'Parsons',
         'Pascucci',
         'Pellerin',
         'Peralta',
         'Percival',
         'Perez-Lucafo',
         'Perry',
         'Peters',
         'Peterson',
         'Pina',
         'Pisano',
         'Power',
         'Powers, Deb',
         'Powers, Tom',
         'Prather',
         'Puglisi',
         'Quinn',
         'Ragucci',
         'Rainha',
         'Rand',
         'Ream',
         'Reide',
         'Reidy',
         'Remy',
         'Reusch',
         'Richard',
         'Rickley',
         'Rivera',
         'Rizzo',
         'Robb',
         'Roddy',
         'Rodier',
         'Rodriguez',
         'Rowe',
         'Ruseckas',
         'Russell',
         'Saad',
         'Salois',
         'Salvesen',
         'Samia',
         'Sanborn',
         'Scarfo',
         'Schofield',
         'Scoggins',
         'Scott',
         'Serapiglia',
         'Shaknovsky',
         'Shea',
         'Sheehy',
         'Smith',
         'Song',
         'Soto',
         'Spinale',
         'St. Laurent',
         'Stevens, Karen',
         'Stevens, Lincoln',
         'Tarricone',
         'Thiede',
         'Timpko',
         'Torrisi-Neel',
         'Trant',
         'Tremblay',
         'Tweedale',
         'Valenti',
         'Vargas',
         'Vazquez',
         'Vives',
         'Wagner',
         'Walke',
         'Wall',
         'Waterman',
         'Waters',
         'Weldin',
         'Westmacott',
         'Whalen',
         'White',
         'Willis',
         'Wilson',
         'Woods',
         'Worthley',
         'Wu',
         'Yanofsky',
         'Yarid',
         'Young',
         'Zawil',
         'Znamierowski',
         'de Kelley'
    ],
    blocks: ["A", "B", "C", "D", "E", "F", "G", "H"],
    semesters: [
    	["2020-09-16", "2021-02-02"],
    	["2021-02-03", "2021-06-16"]
    ]
}

const bellSchedules = {
	hybrid: [
		[[8, 15], [9, 42]],
		[[9, 49], [11, 14]],
		[[11, 19], [13, 17]],
		[[13, 24], [14, 51]]
	],
	remote: [
		[[8, 15], [8, 45]],
		[[8, 50], [9, 20]],
		[[9, 25], [9, 55]],
		[[10, 0], [10, 30]],
		[[10, 35], [11, 5]],
		[[11, 10], [11, 40]],
		[[11, 45], [12, 15]]
	],
	half: [
		[[7, 44], [8, 32]],
	    [[8, 36], [9, 23]],
	    [[9, 27], [10, 14]],
	    [[10, 18], [11, 5]]
	],
	exam: [
		[[8, 0], [9, 30]],
    	[[10, 0], [11, 30]]
	]
}

const exclusions = [
	{
		type: "holiday",
        start: "2020-10-09",
        end: "2020-10-09",
        description: "Professional Development"
    },
    {
        type: "holiday",
        start: "2020-10-12",
        end: "2020-10-12",
        description: "Columbus Day"
    },
    {
        type: "holiday",
        start: "2020-11-03",
        end: "2020-11-03",
        description: "Professional Development"
    },
    {
        type: "holiday",
        start: "2020-11-11",
        end: "2020-11-11",
        description: "Veterans Day"
    },
    {
        type: "customDay",
        start: "2020-11-25",
        end: "2020-11-25",
        timetable: bellSchedules.half,
        description: "Remote Half Day",
        cohortsInPerson: [],
        blocks: "????"
    },
    {
        type: "holiday",
        start: "2020-11-26",
        end: "2020-11-27",
        description: "Thanksgiving Recess"
    },
    {
        type: "customDay",
        start: "2020-12-09",
        end: "2020-12-09",
        timetable: bellSchedules.half,
        description: "Half Day",
        cohortsInPerson: [],
        blocks: "????"
    },
    {
        type: "holiday",
        start: "2020-12-24",
        end: "2021-01-01",
        description: "Christmas Recess"
    },
    {
        type: "holiday",
        start: "2021-01-18",
        end: "2021-01-18",
        description: "Martin Luther King Jr. Day"
    },
    {
    	type: "customDay",
    	start: "2021-01-26",
    	end: "2021-01-26",
    	timetable: bellSchedules.hybrid,
    	description: "Unknown Gold Day",
    	cohortsInPerson: ["gold"],
    	blocks: "????"
    },
    {
    	type: "customDay",
    	start: "2021-01-27",
    	end: "2021-01-28",
    	timetable: bellSchedules.exam,
    	description: "Unknown Exam Day",
    	cohortsInPerson: [],
    	blocks: "??"
    },
    {
        type: "holiday",
        start: "2021-01-29",
        end: "2021-01-29",
        description: "Professional Development"
    },
    {
    	type: "customDay",
    	start: "2021-02-01",
    	end: "2021-02-02",
    	timetable: bellSchedules.exam,
    	description: "Unknown Exam Day",
    	cohortsInPerson: [],
    	blocks: "??"
    },
    {
        type: "holiday",
        start: "2021-02-15",
        end: "2021-02-19",
        description: "Winter Recess"
    },
    {
        type: "customDay",
        start: "2021-03-19",
        end: "2021-03-19",
        timetable: bellSchedules.half,
        description: "Gold Half Day",
        cohortsInPerson: ["gold"],
        blocks: "????"
    },
    {
        type: "customDay",
        start: "2021-04-02",
        end: "2021-04-02",
        timetable: bellSchedules.half,
        description: "Gold Half Day",
        cohortsInPerson: ["gold"],
        blocks: "????"
    },
    {
        type: "holiday",
        start: "2021-04-19",
        end: "2021-04-23",
        description: "Spring Recess"
    },
    {
        type: "customDay",
        start: "2021-05-07",
        end: "2021-05-07",
        timetable: bellSchedules.half,
        description: "Gold Half Day",
        cohortsInPerson: ["gold"],
        blocks: "????"
    },
    {
        type: "holiday",
        start: "2021-05-31",
        end: "2021-05-31",
        description: "Memorial Day"
    },
    {
        type: "customDay",
        start: "2021-06-04",
        end: "2021-06-04",
        timetable: bellSchedules.half,
        description: "Gold Half Day",
        cohortsInPerson: ["gold"],
        blocks: "????"
    },
    {
        type: "customDay",
        start: "2021-06-10",
        end: "2021-06-10",
        timetable: bellSchedules.hybrid,
        description: "Blue Day 1",
        cohortsInPerson: ["blue"],
        blocks: "ACEG"
    },
    {
        type: "customDay",
        start: "2021-06-11",
        end: "2021-06-11",
        timetable: bellSchedules.exam,
        description: "Unknown Exam Day",
        cohortsInPerson: [],
        blocks: "??"
    },
    {
        type: "customDay",
        start: "2021-06-14",
        end: "2021-06-16",
        timetable: bellSchedules.exam,
        description: "Unknown Exam Day",
        cohortsInPerson: [],
        blocks: "??"
    }
]

const fmt = {
	// All dates are UTC in JS context
	parseIsoDate: iso => {
		const [year, month, day] = iso.split('-').map(it => parseInt(it))
		return new Date(Date.UTC(year, month - 1, day))
	},
	toIsoDate: date => {
		const year = date.getUTCFullYear().toString()
		const month = (date.getUTCMonth() + 1).toString()
		const day = date.getUTCDate().toString()
		const padded = str => str.length < 2 ? padded('0' + str) : str
		return [year, padded(month), padded(day)].join('-')
	}
}

// Begin: AHS calendar specification layers

const util = {
	semester: date => {
		for (let i = 0; i < calendar.semesters.length; i++) {
			const [start, end] = calendar.semesters[i].map(fmt.parseIsoDate)
			if (date.getTime() >= start.getTime() && date.getTime() <= end.getTime()) {
				return i + 1
			}
		}
		return null
	},
	zipBellBlocks: (intervals, blocks) => intervals.map(
		(interval, i) => ({interval: interval, block: blocks[i]})),
	relativeToExclusion: (date, exclusion) => {
		const start = fmt.parseIsoDate(exclusion.start).getTime()
		const end = fmt.parseIsoDate(exclusion.end).getTime()
		const time = date.getTime()
		if (time < start) return -1;
		if (time > end) return 1;
		return 0
	},
	searchExclusion: date => {
		let min = 0, max = exclusions.length
		while (min < max) {
			const mid = Math.floor((min + max) / 2)
			const comp = util.relativeToExclusion(date, exclusions[mid])

			if (comp < 0) {
				max = mid
			} else if (comp > 0) {
				min = mid + 1
			} else {
				return exclusions[mid]
			}
		}
		return null
	}
}

const layers = [
	{
		// exclusions (above)
		when: date => util.searchExclusion(date) !== null,
		generate: date => {
			const exclusion = util.searchExclusion(date)
			if (exclusion.type === 'holiday')
				return {
					description: exclusion.description
				}
			else if (exclusion.type === 'customDay')
				return {
					description: exclusion.description,
					periods: util.zipBellBlocks(exclusion.timetable, exclusion.blocks),
					cohortsInPerson: exclusion.cohortsInPerson
				}
		}
	},
	{
		// regular blue days
		when: date => date.getUTCDay() === 1 || date.getUTCDay() === 2,
		generate: date => ({
			description: 'Blue Day ' + date.getUTCDay().toString(),
			periods: util.zipBellBlocks(bellSchedules.hybrid, date.getUTCDay() === 1 ? "ACEG" : "BHDF"),
			cohortsInPerson: ["blue"]
		})
	},
	{
		// regular gold days
		when: date => date.getUTCDay() === 4 || date.getUTCDay() === 5,
		generate: date => ({
			description: 'Gold Day ' + (date.getUTCDay() - 3).toString(),
			periods: util.zipBellBlocks(bellSchedules.hybrid, date.getUTCDay() === 4 ? "ACEG" : "BHDF"),
			cohortsInPerson: ["gold"]
		})
	},
	{
		// regular remote days
		when: date => date.getUTCDay() === 3,
		generate: date => ({
			description: 'Remote Day',
			periods: util.zipBellBlocks(bellSchedules.remote, "ABCDEFG"),
			cohortsInPerson: []
		})
	},
	{
		// regular weekends
		when: date => date.getUTCDay() === 0 || date.getUTCDay() === 6,
		generate: date => ({
			description: 'Weekend'
		})
	}
]

export function dayOn(dateString) {
	const date = fmt.parseIsoDate(dateString)
	const semester = util.semester(date)

	if (semester === null)
		return null

	for (const layer of layers) {
		if (layer.when(date)) {
			const info = layer.generate(date)
			info.date = dateString
			info.semester = semester
			return info
		}
	}

	return null
}
